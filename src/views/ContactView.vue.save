<template>
  <div class="contact-container">
    <div class="contact-header">
      <button class="icon-button" @click="toggleSearch">ğŸ”</button>
      <h2>é€£çµ¡å…ˆãƒªã‚¹ãƒˆ</h2>
      <button class="add-button" @click="openNewContactModal">ï¼‹è¿½åŠ </button>
    </div>

    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div v-if="isSearching" class="search-bar">
      <input v-model="searchQuery" placeholder="åå‰ã¾ãŸã¯ãµã‚ŠãŒãªã§æ¤œç´¢" />
    </div>

    <!-- é€£çµ¡å…ˆä¸€è¦§ -->
    <div v-if="filteredContacts.length === 0" class="empty-message">
      ç™»éŒ²ã•ã‚ŒãŸé€£çµ¡å…ˆãŒã‚ã‚Šã¾ã›ã‚“
    </div>
    <div v-else class="contact-list">
      <div v-for="contact in filteredContacts" :key="contact.id" class="contact-card">
        <h3>{{ contact.name }}</h3>
        <p v-for="(phone, idx) in contact.phoneNumbers" :key="'phone-' + idx">ğŸ“ {{ phone }}</p>
        <p v-for="(email, idx) in contact.emails" :key="'email-' + idx">âœ‰ï¸ {{ email }}</p>

        <!-- èŠ½ãƒ»èŠ±ãƒ»æ¯ã‚Œã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="status-icon">
          {{ getLifeStageIcon(contact) }}
        </div>

        <div class="button-row">
          <button class="btn-active" @click="openEditModal(contact)">ç·¨é›†</button>
          <button class="btn-danger" @click="deleteContactItem(contact.id)">å‰Šé™¤</button>
        </div>
      </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <transition name="modal">
      <div v-if="showModal" class="modal" @click.self="closeModal">
        <div class="modal-content">
          <h3 v-if="isEditMode">é€£çµ¡å…ˆã‚’ç·¨é›†</h3>
          <h3 v-else>æ–°ã—ã„é€£çµ¡å…ˆã‚’è¿½åŠ </h3>

          <input v-model="newContactName" placeholder="åå‰" />
          <input v-model="newContactFurigana" placeholder="ãµã‚ŠãŒãªï¼ˆä»»æ„ï¼‰" />

          <div v-for="(phone, idx) in newContactPhones" :key="'phone-' + idx" class="input-row">
            <input v-model="newContactPhones[idx]" placeholder="é›»è©±ç•ªå·" />
          </div>
          <button @click="addPhoneField">ï¼‹é›»è©±ç•ªå·ã‚’è¿½åŠ </button>

          <div v-for="(email, idx) in newContactEmails" :key="'email-' + idx" class="input-row">
            <input v-model="newContactEmails[idx]" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
          </div>
          <button @click="addEmailField">ï¼‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ </button>

          <div class="button-row">
            <button class="btn-active" @click="saveContact">{{ isEditMode ? 'æ›´æ–°' : 'ä¿å­˜' }}</button>
            <button class="btn-disabled" @click="closeModal">é–‰ã˜ã‚‹</button>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { API, Auth, graphqlOperation } from 'aws-amplify'
import { createContact, updateContact, deleteContact } from '@/graphql/mutations'
import { listContacts } from '@/graphql/queries'

const contacts = ref([])
const showModal = ref(false)
const isEditMode = ref(false)
const editingContactId = ref('')
const isSearching = ref(false)
const searchQuery = ref('')

const newContactName = ref('')
const newContactFurigana = ref('')
const newContactPhones = ref([''])
const newContactEmails = ref([''])

const filteredContacts = computed(() => {
  if (!searchQuery.value) return contacts.value
  const keyword = searchQuery.value.toLowerCase()
  return contacts.value.filter(contact =>
    (contact.name && contact.name.toLowerCase().includes(keyword)) ||
    (contact.furigana && contact.furigana.toLowerCase().includes(keyword))
  )
})

async function saveContact() {
  try {
    const user = await Auth.currentAuthenticatedUser()
    const now = new Date().toISOString()

    if (isEditMode.value) {
      const input = {
        id: editingContactId.value,
        name: newContactName.value,
        furigana: newContactFurigana.value.trim(),
        phoneNumbers: newContactPhones.value.filter(p => p.trim() !== ''),
        emails: newContactEmails.value.filter(e => e.trim() !== ''),
        owner: user.username,
        lastOpenedAt: now,
      }
      await API.graphql(graphqlOperation(updateContact, { input }))
    } else {
      const input = {
        name: newContactName.value,
        furigana: newContactFurigana.value.trim(),
        phoneNumbers: newContactPhones.value.filter(p => p.trim() !== ''),
        emails: newContactEmails.value.filter(e => p.trim() !== ''),
        owner: user.username,
        createdAt: now,
        lastOpenedAt: now,
      }
      await API.graphql(graphqlOperation(createContact, { input }))
    }

    await fetchContacts()
    closeModal()
  } catch (e) {
    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e)
  }
}

async function fetchContacts() {
  try {
    const user = await Auth.currentAuthenticatedUser()
    const res = await API.graphql(graphqlOperation(listContacts, {
      filter: { owner: { eq: user.username } }
    }))
    contacts.value = res.data.listContacts.items.map(item => ({
      id: item.id,
      name: item.name,
      furigana: item.furigana || '',
      phoneNumbers: item.phoneNumbers || [],
      emails: item.emails || [],
      note: item.note || '',
      createdAt: item.createdAt,
      lastOpenedAt: item.lastOpenedAt || item.createdAt,
    }))
    contacts.value = contacts.value.sort((a, b) => {
      const aFurigana = a.furigana || 'ã‚“ã‚“ã‚“'
      const bFurigana = b.furigana || 'ã‚“ã‚“ã‚“'
      return aFurigana.localeCompare(bFurigana, 'ja')
    })
  } catch (e) {
    console.error('fetchContacts error:', e)
  }
}

function openNewContactModal() {
  isEditMode.value = false
  editingContactId.value = ''
  newContactName.value = ''
  newContactFurigana.value = ''
  newContactPhones.value = ['']
  newContactEmails.value = ['']
  showModal.value = true
}

function openEditModal(contact) {
  isEditMode.value = true
  editingContactId.value = contact.id
  newContactName.value = contact.name
  newContactFurigana.value = contact.furigana
  newContactPhones.value = contact.phoneNumbers.length ? [...contact.phoneNumbers] : ['']
  newContactEmails.value = contact.emails.length ? [...contact.emails] : ['']
  showModal.value = true
}

async function deleteContactItem(id) {
  if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    try {
      await API.graphql(graphqlOperation(deleteContact, { input: { id } }))
      await fetchContacts()
    } catch (e) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e)
    }
  }
}

function toggleSearch() {
  isSearching.value = !isSearching.value
  if (!isSearching.value) {
    searchQuery.value = ''
  }
}

function addPhoneField() {
  newContactPhones.value.push('')
}

function addEmailField() {
  newContactEmails.value.push('')
}

// èŠ½ãƒ»èŠ±ãƒ»æ¯ã‚Œã‚’åˆ¤å®šã™ã‚‹
function getLifeStageIcon(contact) {
  const now = new Date()
  const lastOpened = new Date(contact.lastOpenedAt)
  const diffDays = (now - lastOpened) / (1000 * 60 * 60 * 24)

  if (diffDays < 180) {
    return 'ğŸŒ±' // èŠ½
  } else if (diffDays < 330) {
    return 'ğŸŒ¸' // èŠ±
  } else if (diffDays < 365) {
    return 'ğŸ¥€' // æ¯ã‚Œã‹ã‘
  } else {
    return 'âŒ' // 1å¹´ä»¥ä¸Š â†’ æ¶ˆã™å¯¾è±¡
  }
}

onMounted(fetchContacts)
</script>

<style scoped>
/* ï¼ˆCSSã‚‚ä»Šã¾ã§ã¨åŒã˜ã€‚å¿…è¦ãªã‚‰å¾Œã§ãƒªãƒ•ã‚¡ã‚¤ãƒ³ã™ã‚‹ï¼ï¼‰ */
</style>
