<template>
  <div class="desktop" :style="wallpaperStyle">

<div v-if="wallpaper === 'effect.sakura'" class="sakura-container">
  <div
    v-for="n in 20"
    :key="n"
    class="sakura"
    :style="getSakuraStyle(n)"
  />
</div>

<div v-if="wallpaper === 'image.bubble.png'" class="bubble-container">
      <div
        v-for="n in 20"
        :key="n"
        class="bubble"
        :style="getBubbleStyle(n)"
      />
    </div>



<div class="icon-grid" :class="{ 'pop-animation': iconPop }">
      <!-- ‚úÖ „Ç´„É¨„É≥„ÉÄ„ÉºÔºàÊñáÂ≠ó„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÆ„Åü„ÇÅÁâπÊÆäÂØæÂøúÔºâ -->
      <button @click="goTo('calendar')" class="icon-button calendar-button" style="background-image: url('/calendar.png')">
        <span class="calendar-date">{{ currentDay }}</span>
        <span class="calendar-month">{{ currentMonthName }}</span>
      </button>

      <!-- ‚úÖ „É°„É¢ -->
      <button @click="goTo('memo')" class="icon-button" style="background-image: url('/memo.icon.png')"></button>

      <!-- ‚úÖ ÈÄ£Áµ°ÂÖà -->
      <button @click="goTo('contact')" class="icon-button" style="background-image: url('/contact.icon.png')"></button>

      <!-- ‚úÖ Êó•Ë®ò -->
      <button @click="goTo('diary')" class="icon-button" style="background-image: url('/diary.icon.png')"></button>

      <!-- ‚úÖ ÂÜôÁúü -->
      <button @click="goTo('photo')" class="icon-button" style="background-image: url('/photo.icon.png')"></button>

      <!-- ‚úÖ ÂãïÁîª -->
      <button @click="goTo('video')" class="icon-button" style="background-image: url('/video.png')"></button>

      <!-- ‚úÖ „É°„ÉÉ„Çª„Éº„Ç∏ -->
      <button @click="goToChatFromHome" class="icon-button chat-button" style="background-image: url('/messege.icon.png')">
        <span v-if="notificationStore.hasUnread" class="notification-dot">üå±</span>
      </button>

      <!-- ‚úÖ È¢®„ÅÆ‰æø„Çä -->
      <button @click="goTo('wind-inbox')" class="icon-button" style="background-image: url('/WindMessage2.png')"></button>

      <!-- ‚úÖ Globe -->
      <button @click="goTo('globe')" class="icon-button" style="background-image: url('/earth.png')"></button>

      <!-- ‚úÖ „Ç≤„Éº„É† -->
      <button @click="goTo('flower-match')" class="icon-button" style="background-image: url('/game.png')"></button>

      <!-- ‚úÖ ÊôÇË®à -->
      <button @click="goTo('time0')" class="icon-button" style="background-image: url('/clock.png')"></button>

      <!-- ‚úÖ Â§©Ê∞ó -->
      <button @click="goTo('weather875')" class="icon-button" style="background-image: url('/weather.icon.png')"></button>

      <!-- ‚úÖ „Éí„É≥„Éà -->
      <button @click="goToIconGuide()" class="icon-button" style="background-image: url('/icon.2.png')"></button>

      <!-- ‚úÖ Ë®≠ÂÆö -->
      <button @click="goToSettingsFromHome()" class="icon-button" style="background-image: url('/setting.png')"></button>

      <!-- ‚úÖ „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ -->
      <button @click="goTo('activity')" class="icon-button" style="background-image: url('/activity.png')"></button>

<button @click="goToGPTMiniFromHome" class="icon-button" style="background-image: url('/ai.icon.png')"></button>

<!-- ‚úÖ ÁõÆÊ®ô -->
<button @click="goTo('mission')" class="icon-button" style="background-image: url('/mission.png')"></button>

<button @click="goTo('shiritori')" class="icon-button" style="background-image: url('/shiritori.icon.png?v=1')"></button>

    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { Auth, API, graphqlOperation } from 'aws-amplify'
import { onCreateMessage } from '@/graphql/subscriptions'
import { useI18n } from 'vue-i18n'
import { useNotificationStore } from '@/stores/notificationStore'
import GlobalFixedHomeButton from '@/components/GlobalFixedHomeButton.vue'


const notificationStore = useNotificationStore()
const router = useRouter()
const wallpaper = ref('')
const subscription = ref(null)

const iconPop = ref(false)

const { t } = useI18n()
const today = new Date()

const currentDay = computed(() => today.getDate())
const currentMonthName = computed(() => t(`calendar.month.${today.getMonth() + 1}`))

const wallpaperStyle = computed(() => {
  if (!wallpaper.value) return {}

  if (wallpaper.value.startsWith('color.')) {
const colorMap = {
'color.lightBlue': '#ecf5fb',    // ÂÖÉ: #e6f0f9 ‚Üí Â∞ë„ÅóÊøÉ„Åè ‚Üí #dceaf7 ‚Üí „Åù„Åì„Åã„ÇâÂ∞ë„ÅóËñÑ„Åè
'color.lightYellow': '#fffbea',  // ÂÖÉ: #fff9e3 ‚Üí Â∞ë„ÅóÊøÉ„Åè ‚Üí #fff2cc ‚Üí „Åù„Åì„Åã„ÇâÂ∞ë„ÅóËñÑ„Åè
'color.lightPurple': '#f8f4fd',  
  'color.gray': '#aaaaaa'
}
    return {
      backgroundColor: colorMap[wallpaper.value] || '#f5f5f5'
    }
  }

  // ‚úÖ ÈÄöÂ∏∏„ÅÆÁîªÂÉèËÉåÊôØÔºàmoon„ÄÅtake „Å™„Å©Ôºâ
  return {
    backgroundImage: `url(/${wallpaper.value})`,
    backgroundSize: 'cover',
    backgroundPosition: 'center',
    backgroundRepeat: 'no-repeat'
  }
})

function runIconPopAnimation() {
  iconPop.value = false
  requestAnimationFrame(() => {
    iconPop.value = true
    setTimeout(() => {
      iconPop.value = false
    }, 300)
  })
}

function goTo(path) {
  router.push(`/${path}`)
}
function goToSettingsFromHome() {
  router.push({ path: '/settings', query: { from: 'home' } })
}
function goToIconGuide() {
  router.push({ path: '/icon-guide', query: { from: 'home' } })
}
function goToChatFromHome() {
  notificationStore.clearUnread()
  router.push({ path: '/chat-rooms', query: { from: 'home' } })
}

function goToGPTMiniFromHome() {
  router.push({ path: '/gpt-mini', query: { from: 'home' } })
}

onMounted(async () => {
  try {
    await Auth.currentAuthenticatedUser()
  } catch {
    router.push('/signin')
    return
  }

  try {
    const user = await Auth.currentAuthenticatedUser()
    wallpaper.value = user.attributes['custom:wallpaper'] || ''
  } catch (error) {
    console.error('‚ùå ËÉåÊôØÁîªÂÉè„ÅÆÂèñÂæóÂ§±Êïó:', error)
  }

  subscription.value = API.graphql(graphqlOperation(onCreateMessage)).subscribe({
    next: ({ value }) => {
      const newMsg = value?.data?.onCreateMessage
      if (newMsg && newMsg.roomId) {
        const currentRoute = router.currentRoute.value
        const isInChatRoom = currentRoute.name === 'chat'
        const isChatRoomList = currentRoute.name === 'chat-rooms'
        const currentChatRoomId = currentRoute.params.roomId
        if ((isInChatRoom && currentChatRoomId === newMsg.roomId) || isChatRoomList) {
          return
        }
        notificationStore.setUnread(true)
      }
    },
    error: (err) => console.error('‚ùå „É°„ÉÉ„Çª„Éº„Ç∏„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„Ç®„É©„Éº:', err)
  })
})

function getBubbleStyle(n) {
  const left = Math.random() * 100
  const size = Math.random() < 0.4
    ? 15 + Math.random() * 10   // Â∞è„Åï„ÇÅÔºà15„Äú25pxÔºâ
    : 40 + Math.random() * 20   // Â§ß„Åç„ÇÅÔºà40„Äú60pxÔºâ
  const delay = Math.random() * 10
  const duration = 20 + Math.random() * 15  // ‚úÖ „ÇÜ„Å£„Åè„ÇäÈï∑„ÇÅÔºà20„Äú35ÁßíÔºâ

  return {
    left: `${left}%`,
    width: `${size}px`,
    height: `${size}px`,
    animationDelay: `${delay}s`,
    animationDuration: `${duration}s`
  }
}

function getSakuraStyle(n) {
  const left = Math.random() * 100
  const size = 20 + Math.random() * 15
  const delay = Math.random() * 10
  const duration = 18 + Math.random() * 10

  return {
    left: `${left}%`,
    width: `${size}px`,
    height: `${size}px`,
    animationDelay: `${delay}s`,
    animationDuration: `${duration}s`
  }
}

onUnmounted(() => {
  if (subscription.value) {
    subscription.value.unsubscribe()
    subscription.value = null
  }
})
</script>

<style scoped>
.desktop {
  height: 100vh;
  width: 100%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  font-family: sans-serif;
  padding-top: 3rem;
  transition: background 0.5s ease-in-out, background-image 0.5s ease-in-out;
}

.icon-grid {
  display: grid;
  grid-template-columns: repeat(4, 70px);
  gap: 1rem 1.5rem;
  justify-content: center;
  margin-top: 2rem;
}

.icon-button {
  width: 70px;
  height: 70px;
  border-radius: 1rem;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-color: #fff;
  border: none;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}

/* PC „Å†„Åë hover „ÇíÊúâÂäπ„Å´„Åô„Çã */
@media (hover: hover) and (pointer: fine) {
  .icon-button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
}

.icon-button:hover {
  transform: none;
  box-shadow: none;
}

.calendar-button {
  position: relative;
}

.calendar-date {
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.7rem;
  font-weight: bold;
  color: #333;
  background: none;
  pointer-events: none;
  line-height: 1;
}

.calendar-month {
  position: absolute;
  top: 24%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.7rem;
  font-weight: 600;
  color: white;
  background: none;
  pointer-events: none;
  text-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
}

.notification-dot {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 20px;
  height: 20px;
  background-color: #ff0000;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-size: 14px;
  line-height: 1;
}

.bubble-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
  z-index: 0;
}

.bubble {
  position: absolute;
  bottom: -60px;
  background-image: url('/bubble.png');
  background-size: cover;
  background-repeat: no-repeat;
  border-radius: 50%; /* ‚úÖ ‰∏∏„Åè„Åô„Çã */
  opacity: 0;
  animation: floatUpFade ease-in-out infinite;
  pointer-events: none;
  filter: blur(0.5px); /* üí´ „Åª„ÅÆ„Åã„Å´„Éú„Ç±„Åï„Åõ„Çã„Å®ÂπªÊÉ≥ÁöÑ */
}

@keyframes floatUpFade {
  0% {
    transform: translateY(0px);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  50% {
    opacity: 0.8;
  }
  90% {
    opacity: 0;
  }
  100% {
    transform: translateY(-120vh);
    opacity: 0;
  }
}

.sakura-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
  z-index: 0;
}

.sakura {
  position: absolute;
  top: -60px;
  background-image: url('/sakura.time10.png');
  background-size: cover;
  background-repeat: no-repeat;
  border-radius: 50%;
  opacity: 1;
  animation: fallDownFade linear infinite;
  pointer-events: none;
}

@keyframes fallDownFade {
  0% {
    transform: translateY(0px) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(120vh) rotate(360deg);
    opacity: 1;
  }
}

@keyframes popAllIcons {
  0%   { transform: scale(1); }
  30%  { transform: scale(1.2); } /* Êã°Â§ß„ÇíÊó©„ÇÅ„Å´ */
  100% { transform: scale(1); }   /* ÊÆã„Çä70%„ÅÆÊôÇÈñì„Åß„ÇÜ„Å£„Åè„ÇäÁ∏Æ„ÇÄ */
}

.pop-animation > .icon-button {
  animation: popAllIcons 1.5s ease;
}
</style>
