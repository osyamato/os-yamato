<template>
  <div class="contact-container">
    <div class="contact-header">
      <button class="icon-button" @click="toggleSearch">ğŸ”</button>
      <h2>é€£çµ¡å…ˆ</h2>
      <button class="add-button" @click="openNewContactModal">ï¼‹</button>
    </div>

    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div v-if="isSearching" class="search-bar">
      <input v-model="searchQuery" placeholder="åå‰ã¾ãŸã¯ãµã‚ŠãŒãªã§æ¤œç´¢" />
    </div>

    <!-- é€£çµ¡å…ˆä¸€è¦§ -->
    <div v-if="filteredContacts.length === 0" class="empty-message">
      ç™»éŒ²ã•ã‚ŒãŸé€£çµ¡å…ˆãŒã‚ã‚Šã¾ã›ã‚“
    </div>
    <div v-else class="contact-list">
<div
  v-for="contact in filteredContacts"
  :key="contact.id"
  class="contact-card"
  @click="openViewModal(contact)"
>
  <!-- ğŸŒ¸ åå‰ï¼‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¨ªä¸¦ã³ã« -->
  <div class="name-with-icon">
    <span class="flower-icon">{{ getLifeStageIcon(contact) }}</span>
    <h3 class="contact-name">{{ contact.name }}</h3>
  </div>

  <!-- ğŸ“ é›»è©±ç•ªå· -->
  <p v-if="contact.phoneNumbers && contact.phoneNumbers.length">
    {{ contact.phoneNumbers[0] }}
  </p>

  <!-- âœ‰ï¸ ãƒ¡ãƒ¼ãƒ« -->
  <p v-if="contact.emails && contact.emails.length">
    {{ contact.emails[0] }}
  </p>

</div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <transition name="modal">
      <div v-if="showModal" class="modal" @click.self="closeModal">
        <div class="modal-content">

          <!-- ğŸŒ¸ ã‚¿ã‚¤ãƒˆãƒ«ä¿®æ­£ç‰ˆ -->
          <h3 class="modal-title">
            <span v-if="!isEditMode" class="flower-icon">
              {{ selectedContact ? getLifeStageIcon(selectedContact) : '' }}
            </span>
            {{ isEditMode ? (selectedContact ? 'é€£çµ¡å…ˆã‚’ç·¨é›†' : 'æ–°ã—ã„é€£çµ¡å…ˆã‚’è¿½åŠ ') : selectedContact?.name }}
          </h3>

          <div v-if="isEditMode">
            <!-- ç·¨é›† or æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ -->
            <input v-model="editName" placeholder="åå‰" />
            <input v-model="editFurigana" placeholder="ãµã‚ŠãŒãªï¼ˆä»»æ„ï¼‰" />
            <input v-model="editPhone" placeholder="é›»è©±ç•ªå·" />
            <input v-model="editEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
            <textarea v-model="editNote" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
            <input v-model="editYamatoId" placeholder="Yamato ID" />

            <div class="button-row">
              <button class="btn-active" @click="saveEdit">ä¿å­˜</button>
              <button class="btn-disabled" @click="cancelEdit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>

          <div v-else>
            <!-- é–²è¦§ãƒ¢ãƒ¼ãƒ‰ -->
            <div class="modal-body">
              <p v-if="selectedContact?.furigana">
                <strong>ãµã‚ŠãŒãª:</strong> {{ selectedContact.furigana }}
              </p>

              <p v-if="selectedContact?.phoneNumbers?.filter(p => p.trim()).length">
                <strong>é›»è©±:</strong> {{ selectedContact.phoneNumbers.filter(p => p.trim()).join(', ') }}
              </p>

              <p v-if="selectedContact?.emails?.filter(e => e.trim()).length">
                <strong>ãƒ¡ãƒ¼ãƒ«:</strong> {{ selectedContact.emails.filter(e => e.trim()).join(', ') }}
              </p>

              <p v-if="selectedContact?.note">
                <strong>ãƒ¡ãƒ¢:</strong> {{ selectedContact.note }}
              </p>

              <p v-if="selectedContact?.yamatoId">
                <strong>Yamato ID:</strong> {{ selectedContact.yamatoId }}
              </p>
            </div>

            <div class="button-row">
              <button class="btn-active" @click="startEdit">ç·¨é›†</button>
              <button class="btn-danger" @click="confirmDelete(selectedContact.id)">å‰Šé™¤</button>
              <button class="btn-disabled" @click="closeModal">é–‰ã˜ã‚‹</button>
            </div>
          </div>

        </div>
      </div>
    </transition>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { API, Auth, graphqlOperation } from 'aws-amplify'
import { createContact, updateContact, deleteContact } from '@/graphql/mutations'
import { listContacts } from '@/graphql/queries'

// --- ãƒ‡ãƒ¼ã‚¿ ---
const contacts = ref([])
const showModal = ref(false)
const isEditMode = ref(false)
const selectedContact = ref(null)
const editingContactId = ref('')
const isSearching = ref(false)
const searchQuery = ref('')

// --- æ–°è¦/ç·¨é›†ç”¨ãƒ•ã‚©ãƒ¼ãƒ  ---
const newContactName = ref('')
const newContactFurigana = ref('')
const newContactPhones = ref([''])
const newContactEmails = ref([''])
const newContactNote = ref('')
const newContactYamatoId = ref('')

const editName = ref('')
const editFurigana = ref('')
const editPhone = ref('')
const editEmail = ref('')
const editNote = ref('')
const editYamatoId = ref('')

function cancelEdit() {
  closeModal()
}


// --- çµã‚Šè¾¼ã¿ ---
const filteredContacts = computed(() => {
  if (!searchQuery.value) return contacts.value
  const keyword = searchQuery.value.toLowerCase()
  return contacts.value.filter(contact =>
    (contact.name && contact.name.toLowerCase().includes(keyword)) ||
    (contact.furigana && contact.furigana.toLowerCase().includes(keyword))
  )
})

// --- é–²è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆï¼‹updatedAtã‚’æ›´æ–°ã™ã‚‹ï¼‰---
async function openViewModal(contact) {
  selectedContact.value = contact
  isEditMode.value = false
  showModal.value = true

  try {
    await API.graphql(graphqlOperation(updateContact, { input: { id: contact.id } }))
    console.log(`âœ… updatedAt æ›´æ–°: ${contact.name}`)
    await fetchContacts()
  } catch (e) {
    console.error('updatedAtæ›´æ–°ã‚¨ãƒ©ãƒ¼:', e)
  }
}

function startEdit() {
  if (!selectedContact.value) return
  isEditMode.value = true
  editName.value = selectedContact.value.name
  editFurigana.value = selectedContact.value.furigana || ''
  editPhone.value = selectedContact.value.phoneNumbers?.[0] || ''
  editEmail.value = selectedContact.value.emails?.[0] || ''
  editNote.value = selectedContact.value.note || ''
  editYamatoId.value = selectedContact.value.yamatoId || ''
}

async function saveEdit() {
  try {
    const user = await Auth.currentAuthenticatedUser()
    
    if (selectedContact.value) {
      // âœï¸ æ—¢å­˜é€£çµ¡å…ˆã®æ›´æ–°
      const input = {
        id: selectedContact.value.id,
        name: editName.value,
        furigana: editFurigana.value,
        phoneNumbers: [editPhone.value],
        emails: [editEmail.value],
        note: editNote.value,
        yamatoId: editYamatoId.value,
        owner: user.username,
      }
      await API.graphql(graphqlOperation(updateContact, { input }))
      console.log('âœ… é€£çµ¡å…ˆ æ›´æ–°æˆåŠŸ')
    } else {
      // âœï¸ æ–°ã—ã„é€£çµ¡å…ˆã‚’ä½œæˆ
      const input = {
        name: editName.value,
        furigana: editFurigana.value,
        phoneNumbers: [editPhone.value],
        emails: [editEmail.value],
        note: editNote.value,
        yamatoId: editYamatoId.value,
        owner: user.username,
      }
      await API.graphql(graphqlOperation(createContact, { input }))
      console.log('âœ… é€£çµ¡å…ˆ æ–°è¦ä½œæˆæˆåŠŸ')
    }

    await fetchContacts()
    closeModal()
  } catch (e) {
    console.error('ç·¨é›†ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e)
  }
}

// --- æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã ---
function openNewContactModal() {
  selectedContact.value = null
  isEditMode.value = true
  editingContactId.value = ''
  editName.value = ''
  editFurigana.value = ''
  editPhone.value = ''
  editEmail.value = ''
  editNote.value = ''
  editYamatoId.value = ''
  showModal.value = true
}

// --- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ ---
function openEditModal(contact) {
  if (!contact) return
  isEditMode.value = true
  editingContactId.value = contact.id
  newContactName.value = contact.name
  newContactFurigana.value = contact.furigana || ''
  newContactPhones.value = contact.phoneNumbers.length ? [...contact.phoneNumbers] : ['']
  newContactEmails.value = contact.emails.length ? [...contact.emails] : ['']
  newContactNote.value = contact.note || ''
  newContactYamatoId.value = contact.yamatoId || ''
}

// --- ä¿å­˜ï¼ˆæ–°è¦ or æ›´æ–°ï¼‰---
async function saveContact() {
  try {
    const user = await Auth.currentAuthenticatedUser()
    const input = {
      name: newContactName.value,
      furigana: newContactFurigana.value.trim(),
      phoneNumbers: newContactPhones.value.filter(p => p.trim() !== ''),
      emails: newContactEmails.value.filter(e => e.trim() !== ''),
      note: newContactNote.value.trim(),
      yamatoId: newContactYamatoId.value.trim(),
      owner: user.username,
    }
    if (editingContactId.value) {
      input.id = editingContactId.value
      await API.graphql(graphqlOperation(updateContact, { input }))
    } else {
      await API.graphql(graphqlOperation(createContact, { input }))
    }
    console.log('âœ… é€£çµ¡å…ˆ ä¿å­˜æˆåŠŸ')
    await fetchContacts()
    closeModal()
  } catch (e) {
    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e)
  }
}

// --- é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã€Œå‰Šé™¤ã€æŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç† ---
function confirmDelete(id) {
  if (!id) return
  if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    deleteContactItem(id)
    closeModal()
  }
}

// --- å‰Šé™¤ ---
async function deleteContactItem(id) {
  try {
    await API.graphql(graphqlOperation(deleteContact, { input: { id } }))
    console.log('âœ… é€£çµ¡å…ˆ å‰Šé™¤æˆåŠŸ')
    await fetchContacts()
    closeModal()
  } catch (e) {
    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e)
  }
}

// --- é€£çµ¡å…ˆä¸€è¦§ã‚’å–å¾— ---
async function fetchContacts() {
  try {
    const user = await Auth.currentAuthenticatedUser()
    const res = await API.graphql(graphqlOperation(listContacts, {
      filter: { owner: { eq: user.username } }
    }))

    const items = res.data.listContacts.items.map(item => ({
      id: item.id,
      name: item.name,
      furigana: item.furigana || '',
      phoneNumbers: item.phoneNumbers || [],
      emails: item.emails || [],
      note: item.note || '',
      yamatoId: item.yamatoId || '',
      createdAt: item.createdAt,
      updatedAt: item.updatedAt || item.createdAt,
    }))

    const now = new Date()
    for (const contact of items) {
      const updated = new Date(contact.updatedAt)
      const diffDays = (now - updated) / (1000 * 60 * 60 * 24)
      if (diffDays > 365) {
        console.log(`ğŸ›‘ è‡ªå‹•å‰Šé™¤å¯¾è±¡: ${contact.name} (${diffDays.toFixed(1)}æ—¥çµŒé)`)
        await API.graphql(graphqlOperation(deleteContact, { input: { id: contact.id } }))
      }
    }

    contacts.value = items.filter(contact => {
      const updated = new Date(contact.updatedAt)
      const diffDays = (now - updated) / (1000 * 60 * 60 * 24)
      return diffDays <= 365
    }).sort((a, b) => {
      const aFurigana = a.furigana || 'ã‚“ã‚“ã‚“'
      const bFurigana = b.furigana || 'ã‚“ã‚“ã‚“'
      return aFurigana.localeCompare(bFurigana, 'ja')
    })
  } catch (e) {
    console.error('fetchContacts error:', e)
  }
}

function enterEditMode() {
  if (selectedContact.value) {
    isEditMode.value = true
    editingContactId.value = selectedContact.value.id
    newContactName.value = selectedContact.value.name
    newContactFurigana.value = selectedContact.value.furigana || ''
    newContactPhones.value = selectedContact.value.phoneNumbers.length ? [...selectedContact.value.phoneNumbers] : ['']
    newContactEmails.value = selectedContact.value.emails.length ? [...selectedContact.value.emails] : ['']
    newContactNote.value = selectedContact.value.note || ''
    newContactYamatoId.value = selectedContact.value.yamatoId || ''
  }
}

// --- ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®š ğŸŒ±ğŸŒ·ğŸ¥€ ---
function getLifeStageIcon(contact) {
  const now = new Date()
  const baseDate = contact.updatedAt ? new Date(contact.updatedAt) : new Date(contact.createdAt)
  const baseDateOnly = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate())
  const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate())
  const diffDays = (nowDateOnly - baseDateOnly) / (1000 * 60 * 60 * 24)

  if (diffDays < 180) {
    return 'ğŸŒ±'
  } else if (diffDays < 330) {
    return 'ğŸŒ·'
  } else {
    return 'ğŸ¥€'
  }
}

// --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ---
function closeModal() {
  showModal.value = false
  isEditMode.value = false
}

// --- æ¤œç´¢ãƒˆã‚°ãƒ« ---
function toggleSearch() {
  isSearching.value = !isSearching.value
  if (!isSearching.value) {
    searchQuery.value = ''
  }
}

// --- æœ€åˆã«ãƒ­ãƒ¼ãƒ‰ ---
onMounted(fetchContacts)
</script>

<style scoped>
.contact-container {
  padding: 2rem;
  font-family: sans-serif;
  text-align: center;
}
.contact-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.add-button, .icon-button {
  background: white;
  border: 1px solid #ccc;
  padding: 0.4rem 0.8rem;
  font-size: 1rem;
  border-radius: 8px;
  cursor: pointer;
}
.icon-button {
  font-size: 1.4rem;
}
.search-bar {
  margin-bottom: 1rem;
}
.search-bar input {
  width: 100%;
  padding: 0.6rem;
  font-size: 1rem;
  box-sizing: border-box;
}
.empty-message {
  color: #888;
  margin: 2rem 0;
}
.contact-list {
  margin: 1rem 0;
}


.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: #fff;
  padding: 2rem;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
}
.input-row {
  margin: 0.5rem 0;
}
input {
  width: 100%;
  padding: 0.6rem;
  font-size: 1rem;
  margin-bottom: 1rem;
  box-sizing: border-box;
}
.button-row {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-top: 1rem;
}
.btn-active {
  background-color: #274c77;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.btn-disabled {
  background-color: #ccc;
  color: #666;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 8px;
  cursor: not-allowed;
}
.btn-danger {
  background-color: #ff4d4f;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
textarea {
  width: 100%;
  padding: 0.6rem;
  font-size: 1rem;
  margin-top: 1rem;
  box-sizing: border-box;
  min-height: 120px; /* âœ… ãƒ¡ãƒ¢ã ã‘é«˜ã•ã‚’æ‹¡å¤§ */
  border-radius: 8px;
  border: 1px solid #ccc;
  resize: vertical; /* ä»»æ„ã§ä¸Šä¸‹ã«ãƒªã‚µã‚¤ã‚ºå¯ã«ã™ã‚‹ãªã‚‰ã“ã‚Œ */
}
.add-button, .icon-button {
  background: transparent;
  border: none;
  padding: 0.4rem 0.8rem;
  font-size: 1.8rem;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
}

/* èƒŒæ™¯ãŒé»’ã„ã¨ã */
body.dark-mode .add-button,
body.dark-mode .icon-button {
  color: white; /* ç™½è‰²ã« */
}

/* èƒŒæ™¯ãŒç™½ã„ã¨ãï¼ˆé€šå¸¸ï¼‰ */
body:not(.dark-mode) .add-button,
body:not(.dark-mode) .icon-button {
  color: #274c77; /* é’è‰²ã« */
}

.name-with-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0.5rem; /* â† å°‘ã—ã ã‘é–“éš”ã‚‚çŸ­ã */
}

.contact-card {
  background: white;
  padding: 0.3rem 0.5rem;  /* ğŸ”µ ã•ã‚‰ã«å°ã•ã */
  margin-bottom: 0.2rem;   /* ğŸ”µ ã‚«ãƒ¼ãƒ‰é–“ã®éš™é–“ã‚‚ç¸®å° */
  border-bottom: 1px solid #ccc;
  border-radius: 0;
  display: flex;
  align-items: center;
  gap: 0.2rem;
  font-size: 0.7rem;       /* ğŸ”µ å…¨ä½“ã®æ–‡å­—ã‚‚å°ã•ã */
  color: #000;
}

.contact-name {
  font-size: 0.9rem;        /* ğŸ”µ ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—ã¯ã‚„ã‚„å¤§ãã‚ */
  font-weight: normal;
  color: #000;
}

.flower-icon {
  font-size: 1.0rem;        /* ğŸ”µ èŠ½ã®ã‚µã‚¤ã‚ºã‚‚ã‚‚ã†å°‘ã—å°ã•ã */
  margin-right: 0.2rem;
  vertical-align: middle;
}

/* ğŸŒ¸ é€šå¸¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
@keyframes dropDown {
  0% {
    transform: translateY(-40px);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes flyUp {
  0% {
    transform: translateY(0);
    opacity: 1;
  }
  100% {
    transform: translateY(-40px);
    opacity: 0;
  }
}

/* ğŸŒ¸ ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.contact-container {
  padding: 2rem;
  font-family: sans-serif;
  text-align: center;
  animation: dropDown 0.6s ease-out; /* â†ã“ã“ */
}

/* ğŸŒ¸ ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.modal-enter-active {
  animation: dropDown 0.4s ease-out;
}
.modal-leave-active {
  animation: flyUp 0.3s ease-in;
}

</style>
