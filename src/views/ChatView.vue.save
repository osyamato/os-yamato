<template>
  <div class="chat-container">
    <!-- ğŸ”¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ -->
    <div class="message-list">
      <div
        v-for="msg in messages"
        :key="msg.id"
        class="message"
        :class="{ mine: msg.senderYamatoId === myYamatoId }"
      >
        <p>{{ msg.content }}</p>
        <span class="timestamp">{{ formatTime(msg.timestamp) }}</span>
      </div>
    </div>

    <!-- ğŸ”½ å…¥åŠ›æ¬„ -->
<div class="input-area">
<textarea
  v-model="newMessage"
  placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
  rows="1"
  class="message-input"
  @input="autoResize"
/>
  <button @click="sendMessage">é€ä¿¡</button>
</div>
  </div>
</template>

<script setup>
import { ref, onMounted, watchEffect } from 'vue'
import { API, graphqlOperation, Auth } from 'aws-amplify'
import { listMessages } from '@/graphql/queries'
import { useRoute } from 'vue-router'
import { nextTick } from 'vue'


// âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å…¥åŠ›æ¬„
const messages = ref([])
const newMessage = ref('')

// âœ… è‡ªåˆ†ã® Yamato IDï¼ˆDynamoDB ã‹ã‚‰å–å¾—ï¼‰
const myYamatoId = ref('')

// âœ… ãƒ«ãƒ¼ãƒˆã‹ã‚‰ roomId / receiverYamatoId ã‚’å–å¾—
const route = useRoute()
const roomId = ref('')
const receiverYamatoId = ref('')

watchEffect(() => {
  roomId.value = route.params.roomId || ''
  receiverYamatoId.value = route.params.receiverYamatoId || ''
})

onMounted(async () => {
  try {
    const user = await Auth.currentAuthenticatedUser()
    const mySub = user.attributes.sub

    const res = await API.graphql({
      query: /* GraphQL */ `
        query GetMyProfile($id: ID!) {
          getPublicProfile(id: $id) {
            yamatoId
          }
        }
      `,
      variables: { id: mySub },
      authMode: 'AMAZON_COGNITO_USER_POOLS'
    })

    myYamatoId.value = res.data.getPublicProfile.yamatoId
    console.log('âœ… è‡ªåˆ†ã® YamatoID:', myYamatoId.value)

    if (!roomId.value || !receiverYamatoId.value) {
      console.error('âŒ roomId ã¾ãŸã¯ receiverYamatoId ãŒæœªè¨­å®šã§ã™')
      return
    }

    await fetchMessages()
  } catch (err) {
    console.error('âŒ Yamato ID ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', err)
  }
})

function autoResize(event) {
  const textarea = event.target
  textarea.style.height = 'auto'  // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
  textarea.style.height = textarea.scrollHeight + 'px'
}

async function fetchMessages() {
  try {
    const res = await API.graphql(graphqlOperation(listMessages, {
      filter: { roomId: { eq: roomId.value } },
      limit: 100
    }))
    messages.value = res.data.listMessages.items
      .filter(msg => msg)
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))

    await nextTick()
    scrollToBottom()
  } catch (err) {
    console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', JSON.stringify(err, null, 2))
  }
}

function scrollToBottom() {
  const container = document.querySelector('.message-list')
  if (container) {
    container.scrollTop = container.scrollHeight
  }
}

async function sendMessage() {
  if (!newMessage.value.trim()) return

  const input = {
    roomId: roomId.value,
    senderYamatoId: myYamatoId.value,
    receiverYamatoId: receiverYamatoId.value,
    content: newMessage.value,
    timestamp: new Date().toISOString()
  }

  const missing = Object.entries(input).filter(([_, v]) => v == null || v === '')
  if (missing.length > 0) {
    console.error('âŒ ä¸æ­£ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã™:', missing)
    return
  }

  try {
    const createMessageMinimal = /* GraphQL */ `
      mutation CreateMessage($input: CreateMessageInput!) {
        createMessage(input: $input) {
          id
          content
          timestamp
          senderYamatoId
          receiverYamatoId
        }
      }
    `
    await API.graphql(graphqlOperation(createMessageMinimal, { input }))
    newMessage.value = ''
    await fetchMessages()
  } catch (err) {
    console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', JSON.stringify(err, null, 2))
  }
}

function formatTime(ts) {
  return new Date(ts).toLocaleTimeString()
}
</script>


<style scoped>
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.message-input {
  width: 100%;
  min-height: 40px;
  max-height: 150px;
  resize: none;
  padding: 0.6rem;
  font-size: 1rem;
  border-radius: 8px;
  border: 1px solid #ccc;
  overflow-y: auto;
  transition: height 0.1s ease-out;
}

.message-list {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.message {
  padding: 0.5rem;
  margin: 0.5rem 0;
  border-radius: 10px;
  background: #f0f0f0;
  color: #222; /* æ˜ã‚‹ã„èƒŒæ™¯ç”¨ã«é»’ã«è¿‘ã„æ–‡å­—è‰²ã‚’æŒ‡å®š */
  max-width: 70%;
}

.message.mine {
  align-self: flex-end;
  background: #d1e7ff;
  color: #222; /* è‡ªåˆ†ã®å¹ãå‡ºã—ã‚‚åŒæ§˜ã«æ˜ç¤º */
}

/* ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
@media (prefers-color-scheme: dark) {
  .message {
    background: #444;
    color: #fff;
  }

  .message.mine {
    background: #276ef1;
    color: #fff;
  }
}

.input-area {
  display: flex;
  padding: 1rem;
  border-top: 1px solid #ccc;
}

input {
  flex: 1;
  padding: 0.6rem;
  margin-right: 0.5rem;
}

button {
  padding: 0.6rem 1rem;
}
</style>
